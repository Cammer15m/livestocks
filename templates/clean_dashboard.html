<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Clean Stock Dashboard - Side-by-Side Comparison</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider {
            width: 80px;
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-fetching {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .sync-timer {
            background: #e9ecef;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sync-delay {
            font-weight: bold;
            color: #dc3545;
        }
        
        .sync-delay.good {
            color: #28a745;
        }
        
        .sync-delay.medium {
            color: #ffc107;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 800px;
        }

        .chart-container {
            padding: 20px;
            height: 300px;
        }

        .logs-section {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 20px;
        }

        .logs-container {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-timestamp {
            color: #a0aec0;
        }

        .log-info {
            color: #68d391;
        }

        .log-warning {
            color: #fbb6ce;
        }

        .log-error {
            color: #fc8181;
        }
        
        .table-section {
            padding: 20px;
            border-right: 1px solid #dee2e6;
        }
        
        .table-section:last-child {
            border-right: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        
        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .refresh-btn:hover {
            background: #218838;
        }
        
        .table-container {
            height: 250px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
        }
        
        th:last-child {
            border-right: none;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }
        
        td:last-child {
            border-right: none;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .surge {
            background: #d4edda;
            color: #155724;
        }
        
        .crash {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Clean Stock Dashboard</h1>
            <p>Side-by-Side PostgreSQL ‚Üî Redis Comparison</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button class="btn" onclick="refreshAll()">üîÑ Refresh All</button>
                <button class="btn" onclick="refreshPostgres()">üìä Refresh PostgreSQL</button>
                <button class="btn" onclick="refreshRedis()">üî¥ Refresh Redis</button>
            </div>

            <div class="control-group">
                <button id="fetchBtn" class="btn" onclick="togglePolygonFetch()">üì° Start Polygon Fetch</button>
                <span id="fetchStatus" class="status-indicator status-stopped">Stopped</span>
            </div>

            <div class="control-group">
                <button id="demoBtn" class="btn" onclick="toggleDemoStock()" style="background: #17a2b8;">üé¨ Start DEMO Stock</button>
                <span id="demoStatus" class="status-indicator status-stopped">Stopped</span>
            </div>

            <div class="control-group">
                <div class="slider-container">
                    <label>Crash %:</label>
                    <input type="range" id="crashSlider" class="slider" min="10" max="50" value="30">
                    <span id="crashValue">30%</span>
                </div>
                <button class="btn" onclick="simulateCrash()" style="background: #dc3545;">üí• Crash</button>
            </div>

            <div class="control-group">
                <div class="slider-container">
                    <label>Surge %:</label>
                    <input type="range" id="surgeSlider" class="slider" min="10" max="50" value="40">
                    <span id="surgeValue">40%</span>
                </div>
                <button class="btn" onclick="simulateSurge()" style="background: #28a745;">üöÄ Surge</button>
            </div>
        </div>
        
        <div class="sync-timer">
            ‚è±Ô∏è PostgreSQL ‚Üí Redis Sync Delay: 
            <span id="syncDelay" class="sync-delay">-- ms</span>
            | Last Update: <span id="lastUpdate">--</span>
        </div>
        
        <div class="main-content">
            <!-- PostgreSQL Section -->
            <div class="table-section">
                <div class="section-header">
                    <div class="section-title">üìä PostgreSQL Data</div>
                    <button class="refresh-btn" onclick="refreshPostgres()">Refresh</button>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="pgTickers">-</div>
                        <div class="stat-label">Tickers</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="pgRecords">-</div>
                        <div class="stat-label">Records</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="pgSuccess">-</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Date</th>
                                <th>Close</th>
                                <th>Volume</th>
                            </tr>
                        </thead>
                        <tbody id="postgresTableBody">
                            <tr>
                                <td colspan="4" class="no-data">Click Refresh to load data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- PostgreSQL Chart -->
                <div class="chart-container">
                    <canvas id="postgresChart"></canvas>
                </div>
            </div>

            <!-- Redis Section -->
            <div class="table-section">
                <div class="section-header">
                    <div class="section-title">üî¥ Redis Data</div>
                    <button class="refresh-btn" onclick="refreshRedis()">Refresh</button>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="redisTotalKeys">-</div>
                        <div class="stat-label">Total Keys</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="redisStockKeys">-</div>
                        <div class="stat-label">Stock Keys</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="redisLatestKeys">-</div>
                        <div class="stat-label">Latest Keys</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Date</th>
                                <th>Close</th>
                                <th>Volume</th>
                            </tr>
                        </thead>
                        <tbody id="redisTableBody">
                            <tr>
                                <td colspan="4" class="no-data">Click Refresh to load data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Redis Chart -->
                <div class="chart-container">
                    <canvas id="redisChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Live Activity Logs -->
        <div class="logs-section">
            <h3>üìù Live Activity Logs</h3>
            <div class="logs-container" id="logsContainer">
                <div class="log-entry">
                    <span class="log-timestamp">[Loading...]</span>
                    <span class="log-info">Clean Stock Dashboard initialized</span>
                </div>
            </div>
        </div>

        <!-- RDI Configuration Display -->
        <div class="logs-section">
            <h3>‚öôÔ∏è RDI Configuration</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>üì° Connection Config</h4>
                    <div class="logs-container" id="rdiConfigContainer" style="height: 300px;">
                        <div class="log-entry">
                            <span class="log-info">Loading RDI configuration...</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h4>üîß Job Definitions</h4>
                    <div class="logs-container" id="rdiJobsContainer" style="height: 300px;">
                        <div class="log-entry">
                            <span class="log-info">Loading RDI jobs...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let postgresUpdateTime = null;
        let redisUpdateTime = null;
        let postgresChart = null;
        let redisChart = null;
        let isFetching = false;

        // Initialize charts
        function initCharts() {
            const stockColors = [
                '#007bff', '#dc3545', '#28a745', '#ffc107', '#6f42c1'
            ];

            const chartConfig = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Top 5 Stocks Real-Time Prices'
                        }
                    }
                }
            };

            postgresChart = new Chart(document.getElementById('postgresChart'), {
                ...chartConfig,
                options: {
                    ...chartConfig.options,
                    plugins: {
                        ...chartConfig.options.plugins,
                        title: {
                            display: true,
                            text: 'PostgreSQL - Top 5 Stocks'
                        }
                    }
                }
            });

            redisChart = new Chart(document.getElementById('redisChart'), {
                ...chartConfig,
                options: {
                    ...chartConfig.options,
                    plugins: {
                        ...chartConfig.options.plugins,
                        title: {
                            display: true,
                            text: 'Redis - Top 5 Stocks'
                        }
                    }
                }
            });
        }

        // Logging functions
        function addLog(message, type = 'info') {
            const container = document.getElementById('logsContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = `log-${type.toLowerCase()}`;

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${logClass}">${message}</span>
            `;

            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;

            // Keep only last 50 log entries
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // Slider controls
        function initSliders() {
            const crashSlider = document.getElementById('crashSlider');
            const surgeSlider = document.getElementById('surgeSlider');
            const crashValue = document.getElementById('crashValue');
            const surgeValue = document.getElementById('surgeValue');

            crashSlider.addEventListener('input', (e) => {
                crashValue.textContent = e.target.value + '%';
            });

            surgeSlider.addEventListener('input', (e) => {
                surgeValue.textContent = e.target.value + '%';
            });
        }
        
        // Polygon fetch controls
        function togglePolygonFetch() {
            const btn = document.getElementById('fetchBtn');
            const status = document.getElementById('fetchStatus');

            if (isFetching) {
                // Stop fetching
                fetch('/api/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            isFetching = false;
                            btn.textContent = 'üì° Start Polygon Fetch';
                            status.textContent = 'Stopped';
                            status.className = 'status-indicator status-stopped';
                            addLog('üõë Stopped Polygon data fetching', 'warning');
                        }
                    })
                    .catch(error => {
                        addLog('‚ùå Error stopping fetch: ' + error, 'error');
                    });
            } else {
                // Start fetching
                fetch('/api/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            isFetching = true;
                            btn.textContent = '‚èπÔ∏è Stop Fetching';
                            status.textContent = 'Fetching';
                            status.className = 'status-indicator status-fetching';
                            addLog('üöÄ Started Polygon data fetching', 'info');
                        }
                    })
                    .catch(error => {
                        addLog('‚ùå Error starting fetch: ' + error, 'error');
                    });
            }
        }

        // Demo stock controls
        let isDemoActive = false;
        function toggleDemoStock() {
            const btn = document.getElementById('demoBtn');
            const status = document.getElementById('demoStatus');

            if (isDemoActive) {
                // Stop demo
                fetch('/api/demo/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            isDemoActive = false;
                            btn.textContent = 'üé¨ Start DEMO Stock';
                            btn.style.background = '#17a2b8';
                            status.textContent = 'Stopped';
                            status.className = 'status-indicator status-stopped';
                            addLog('üõë Stopped DEMO stock updates', 'warning');
                        }
                    })
                    .catch(error => {
                        addLog('‚ùå Error stopping DEMO stock: ' + error, 'error');
                    });
            } else {
                // Start demo
                fetch('/api/demo/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            isDemoActive = true;
                            btn.textContent = '‚èπÔ∏è Stop DEMO';
                            btn.style.background = '#dc3545';
                            status.textContent = 'Running';
                            status.className = 'status-indicator status-fetching';
                            addLog('üé¨ Started DEMO stock continuous updates (every 3-7 seconds)', 'info');
                        }
                    })
                    .catch(error => {
                        addLog('‚ùå Error starting DEMO stock: ' + error, 'error');
                    });
            }
        }

        // Crash/Surge simulation
        function simulateCrash() {
            const percentage = document.getElementById('crashSlider').value;
            addLog(`üí• Simulating market crash (up to ${percentage}% drop per stock)...`, 'warning');

            fetch('/api/simulate/crash', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ intensity: parseInt(percentage) / 100 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`üí• Market crash applied! Each stock dropped by different amounts`, 'warning');
                    setTimeout(() => {
                        refreshAll();
                        addLog('üìä Data refreshed after crash simulation', 'info');
                    }, 1000);
                } else {
                    addLog('‚ùå Crash simulation failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                addLog('‚ùå Error simulating crash: ' + error, 'error');
            });
        }

        function simulateSurge() {
            const percentage = document.getElementById('surgeSlider').value;
            addLog(`üöÄ Simulating market surge (up to ${percentage}% gain per stock)...`, 'info');

            fetch('/api/simulate/upturn', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ intensity: parseInt(percentage) / 100 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`üöÄ Market surge applied! Each stock gained by different amounts`, 'info');
                    setTimeout(() => {
                        refreshAll();
                        addLog('üìä Data refreshed after surge simulation', 'info');
                    }, 1000);
                } else {
                    addLog('‚ùå Surge simulation failed: ' + data.error, 'error');
                }
            })
            .catch(error => {
                addLog('‚ùå Error simulating surge: ' + error, 'error');
            });
        }

        function refreshAll() {
            addLog('üîÑ Refreshing all data...', 'info');
            refreshPostgres();
            setTimeout(refreshRedis, 500); // Slight delay to measure sync
        }
        
        function refreshPostgres() {
            postgresUpdateTime = Date.now();

            fetch('/api/data/daily_aggregates')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePostgresTable(data.data);
                        updatePostgresStats(data.data);
                        updatePostgresChart(data.data);
                        addLog(`üìä PostgreSQL: ${data.data.length} records loaded`, 'info');
                    } else {
                        addLog('‚ùå PostgreSQL fetch failed: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    addLog('‚ùå PostgreSQL fetch error: ' + error, 'error');
                });
        }
        
        function refreshRedis() {
            redisUpdateTime = Date.now();

            fetch('/api/redis/stocks')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateRedisTable(data.stocks);
                        updateRedisStats(data);
                        updateRedisChart(data.stocks);
                        updateSyncDelay();
                        addLog(`üî¥ Redis: ${data.stocks.length} records synced`, 'info');
                    } else {
                        addLog('‚ùå Redis fetch failed: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    addLog('‚ùå Redis fetch error: ' + error, 'error');
                });
        }
        
        function updatePostgresTable(data) {
            const tbody = document.getElementById('postgresTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No PostgreSQL data available</td></tr>';
                return;
            }
            
            // Show latest 5 records
            const records = data.slice(0, 5);
            
            tbody.innerHTML = records.map(row => {
                const date = new Date(row.date).toLocaleDateString();
                const close = parseFloat(row.close || 0).toFixed(2);
                const volume = parseInt(row.volume || 0).toLocaleString();
                
                return `
                    <tr>
                        <td>${row.ticker}</td>
                        <td>${date}</td>
                        <td>$${close}</td>
                        <td>${volume}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateRedisTable(stocks) {
            const tbody = document.getElementById('redisTableBody');

            if (!stocks || stocks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No Redis data available</td></tr>';
                return;
            }

            // Sort all stocks by ticker and date (newest first) to match PostgreSQL format
            const sortedStocks = stocks
                .filter(stock => stock.ticker && stock.close)
                .sort((a, b) => {
                    // First sort by ticker
                    const tickerCompare = a.ticker.localeCompare(b.ticker);
                    if (tickerCompare !== 0) return tickerCompare;

                    // Then by date (newest first)
                    const dateA = new Date(a.date || a.timestamp);
                    const dateB = new Date(b.date || b.timestamp);
                    return dateB - dateA;
                })
                .slice(0, 5); // Show same number as PostgreSQL
            
            tbody.innerHTML = sortedStocks.map(stock => {
                const date = stock.date ? new Date(stock.date).toLocaleDateString() : 'N/A';
                const close = parseFloat(stock.close || 0).toFixed(2);
                const volume = parseInt(stock.volume || 0).toLocaleString();
                
                // Check for crash/surge indicators
                let statusIndicator = '';
                if (stock.event_type === 'SURGE') {
                    statusIndicator = '<span class="status-indicator surge">SURGE</span>';
                } else if (stock.event_type === 'CRASH') {
                    statusIndicator = '<span class="status-indicator crash">CRASH</span>';
                }
                
                return `
                    <tr>
                        <td>${stock.ticker}${statusIndicator}</td>
                        <td>${date}</td>
                        <td>$${close}</td>
                        <td>${volume}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updatePostgresStats(data) {
            const tickers = new Set(data.map(row => row.ticker)).size;
            document.getElementById('pgTickers').textContent = tickers;
            document.getElementById('pgRecords').textContent = data.length;
            document.getElementById('pgSuccess').textContent = '100%';
        }
        
        function updateRedisStats(data) {
            document.getElementById('redisTotalKeys').textContent = data.total_keys || 0;
            document.getElementById('redisStockKeys').textContent = data.stock_keys || 0;
            document.getElementById('redisLatestKeys').textContent = data.latest_keys || 0;
        }
        
        function updatePostgresChart(data) {
            if (!postgresChart || !data || data.length === 0) return;

            // Group by ticker and get latest prices
            const tickerData = {};
            data.forEach(row => {
                if (!tickerData[row.ticker]) {
                    tickerData[row.ticker] = [];
                }
                tickerData[row.ticker].push({
                    date: row.date,
                    price: parseFloat(row.close)
                });
            });

            // Get top 6 tickers including DEMO and create datasets
            const tickers = ['DEMO', 'AAPL', 'AMZN', 'GOOGL', 'MSFT', 'TSLA'];
            const stockColors = ['#ff6b35', '#007bff', '#dc3545', '#28a745', '#ffc107', '#6f42c1'];

            // Get all unique dates and sort them
            const allDates = [...new Set(data.map(row => row.date))]
                .sort((a, b) => new Date(a) - new Date(b))
                .slice(-10); // Last 10 dates

            postgresChart.data.labels = allDates.map(date =>
                new Date(date).toLocaleDateString()
            );

            // Create datasets for each ticker
            postgresChart.data.datasets = tickers.map((ticker, index) => {
                const tickerPrices = allDates.map(date => {
                    const dayData = tickerData[ticker]?.find(d => d.date === date);
                    return dayData ? dayData.price : null;
                });

                return {
                    label: ticker,
                    data: tickerPrices,
                    borderColor: stockColors[index],
                    backgroundColor: stockColors[index] + '20',
                    tension: 0.4,
                    fill: false,
                    pointRadius: 3
                };
            });

            postgresChart.update();
        }

        function updateRedisChart(stocks) {
            if (!redisChart || !stocks || stocks.length === 0) return;

            // Group by ticker and get latest prices
            const tickerData = {};
            stocks.forEach(stock => {
                if (!tickerData[stock.ticker]) {
                    tickerData[stock.ticker] = [];
                }
                tickerData[stock.ticker].push({
                    date: stock.date || stock.timestamp,
                    price: parseFloat(stock.close)
                });
            });

            // Get top 6 tickers including DEMO and create datasets
            const tickers = ['DEMO', 'AAPL', 'AMZN', 'GOOGL', 'MSFT', 'TSLA'];
            const stockColors = ['#ff6b35', '#007bff', '#dc3545', '#28a745', '#ffc107', '#6f42c1'];

            // Get all unique dates and sort them
            const allDates = [...new Set(stocks.map(stock => stock.date || stock.timestamp))]
                .filter(date => date && date !== 'N/A')
                .sort((a, b) => new Date(a) - new Date(b))
                .slice(-10); // Last 10 dates

            if (allDates.length === 0) return;

            redisChart.data.labels = allDates.map(date =>
                new Date(date).toLocaleDateString()
            );

            // Create datasets for each ticker
            redisChart.data.datasets = tickers.map((ticker, index) => {
                const tickerPrices = allDates.map(date => {
                    const dayData = tickerData[ticker]?.find(d => (d.date || d.timestamp) === date);
                    return dayData ? dayData.price : null;
                });

                return {
                    label: ticker,
                    data: tickerPrices,
                    borderColor: stockColors[index],
                    backgroundColor: stockColors[index] + '20',
                    tension: 0.4,
                    fill: false,
                    pointRadius: 3
                };
            });

            redisChart.update();
        }

        function updateSyncDelay() {
            if (postgresUpdateTime && redisUpdateTime) {
                const delay = Math.abs(redisUpdateTime - postgresUpdateTime);
                const delayElement = document.getElementById('syncDelay');

                delayElement.textContent = delay.toFixed(0) + ' ms';

                // Color code the delay
                delayElement.className = 'sync-delay';
                if (delay < 100) {
                    delayElement.classList.add('good');
                    addLog(`‚ö° Fast sync: ${delay.toFixed(0)}ms`, 'info');
                } else if (delay < 500) {
                    delayElement.classList.add('medium');
                    addLog(`‚ö†Ô∏è Medium sync delay: ${delay.toFixed(0)}ms`, 'warning');
                } else {
                    addLog(`üêå Slow sync delay: ${delay.toFixed(0)}ms`, 'warning');
                }

                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            }
        }

        // Load RDI configuration
        function loadRDIConfig() {
            fetch('/api/rdi/config')
                .then(response => response.json())
                .then(config => {
                    const container = document.getElementById('rdiConfigContainer');
                    container.innerHTML = `
                        <div class="log-entry">
                            <span class="log-info">üì° PostgreSQL Source:</span>
                        </div>
                        <div class="log-entry">
                            <span class="log-timestamp">Host:</span>
                            <span>${config.sources.postgresql.connection.host}:${config.sources.postgresql.connection.port}</span>
                        </div>
                        <div class="log-entry">
                            <span class="log-timestamp">Database:</span>
                            <span>${config.sources.postgresql.connection.database}</span>
                        </div>
                        <div class="log-entry">
                            <span class="log-timestamp">Type:</span>
                            <span>${config.sources.postgresql.type.toUpperCase()}</span>
                        </div>
                        <div class="log-entry">
                            <span class="log-info">üî¥ Redis Target:</span>
                        </div>
                        <div class="log-entry">
                            <span class="log-timestamp">Host:</span>
                            <span>${config.targets.redis_cloud.connection.host}:${config.targets.redis_cloud.connection.port}</span>
                        </div>
                        <div class="log-entry">
                            <span class="log-timestamp">Type:</span>
                            <span>${config.targets.redis_cloud.connection.type.toUpperCase()}</span>
                        </div>
                    `;
                })
                .catch(error => {
                    addLog('‚ùå Error loading RDI config: ' + error, 'error');
                });
        }

        function loadRDIJobs() {
            fetch('/api/rdi/jobs')
                .then(response => response.json())
                .then(jobs => {
                    const container = document.getElementById('rdiJobsContainer');
                    let html = '';

                    Object.keys(jobs).forEach(jobKey => {
                        const job = jobs[jobKey];
                        html += `
                            <div class="log-entry">
                                <span class="log-info">üìã ${job.name}</span>
                            </div>
                            <div class="log-entry">
                                <span class="log-timestamp">Source:</span>
                                <span>${job.config.source.table}</span>
                            </div>
                            <div class="log-entry">
                                <span class="log-timestamp">Transforms:</span>
                                <span>${job.config.transform ? job.config.transform.length : 0} steps</span>
                            </div>
                            <div class="log-entry">
                                <span class="log-timestamp">Output:</span>
                                <span>Redis keys</span>
                            </div>
                            <div class="log-entry"><span>---</span></div>
                        `;
                    });

                    container.innerHTML = html;
                })
                .catch(error => {
                    addLog('‚ùå Error loading RDI jobs: ' + error, 'error');
                });
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            initSliders();
            addLog('üöÄ Clean Stock Dashboard initialized', 'info');

            // Load RDI configuration
            loadRDIConfig();
            loadRDIJobs();

            // Auto-refresh every 30 seconds
            setInterval(refreshAll, 30000);

            // Initial load
            setTimeout(refreshAll, 1000);
        });
    </script>
</body>
</html>
