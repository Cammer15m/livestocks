source:
  table: daily_aggregates

transform:
  - uses: add_field
    with:
      field: price_change
      expression: close - open
      language: sql

  - uses: add_field
    with:
      field: price_change_percent
      expression: round(((close - open) / open) * 100, 2)
      language: sql

  - uses: filter
    with:
      expression: date = (SELECT MAX(date) FROM daily_aggregates)
      language: sql

output:
  - uses: redis.write
    with:
      connection: target
      key:
        expression: concat('latest:', ticker)
        language: sql
      value:
        expression: to_json_string(*)
        language: sql
