source:
  table: daily_aggregates

transform:
  - uses: add_field
    with:
      field: stock_key
      expression: concat(ticker, ':', date)
      language: sql

  - uses: add_field
    with:
      field: price_change
      expression: close - open
      language: sql

  - uses: add_field
    with:
      field: price_change_percent
      expression: round(((close - open) / open) * 100, 2)
      language: sql

  - uses: add_field
    with:
      field: trading_range
      expression: high - low
      language: sql

  - uses: add_field
    with:
      field: volume_millions
      expression: round(volume / 1000000.0, 2)
      language: sql

output:
  - uses: redis.write
    with:
      connection: target
      key:
        expression: concat('stock:', ticker, ':', date)
        language: sql
      value:
        expression: to_json_string(*)
        language: sql
